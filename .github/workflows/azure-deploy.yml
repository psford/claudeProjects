name: Deploy to Azure Production

# PRODUCTION DEPLOYMENT - Manual trigger only
# This workflow builds, tests, and deploys to production.
# It requires manual approval via workflow_dispatch.

on:
  # Remove automatic push trigger - production deploys are manual only
  # push:
  #   branches: [master, main]

  # Manual trigger with confirmation
  workflow_dispatch:
    inputs:
      confirm_deploy:
        description: 'Type "deploy" to confirm production deployment'
        required: true
        type: string
      reason:
        description: 'Reason for deployment (shown in logs)'
        required: true
        type: string

env:
  AZURE_WEBAPP_NAME: app-stockanalyzer-prod
  DOTNET_VERSION: '8.0.x'
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/stockanalyzer
  ACR_NAME: acrstockanalyzerer34ug
  ACR_LOGIN_SERVER: acrstockanalyzerer34ug.azurecr.io

jobs:
  # Validate deployment confirmation
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Validate confirmation
        if: ${{ github.event.inputs.confirm_deploy != 'deploy' }}
        run: |
          echo "::error::Deployment not confirmed. You must type 'deploy' to proceed."
          exit 1

      - name: Log deployment reason
        run: |
          echo "## Production Deployment" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Reason:** ${{ github.event.inputs.reason }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

  build-and-test:
    needs: validate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore dependencies
        run: dotnet restore stock_analyzer_dotnet/StockAnalyzer.sln

      - name: Build
        run: dotnet build stock_analyzer_dotnet/StockAnalyzer.sln --configuration Release --no-restore

      - name: Test
        run: dotnet test stock_analyzer_dotnet/StockAnalyzer.sln --configuration Release --no-build --verbosity normal

  build-container:
    needs: build-and-test
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
      image-digest: ${{ steps.build.outputs.digest }}
    steps:
      - uses: actions/checkout@v4

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=sha,prefix=
            type=raw,value=latest
            type=raw,value=prod-${{ github.run_number }}

      - name: Build and push Docker image to GHCR
        id: build
        uses: docker/build-push-action@v5
        with:
          context: ./stock_analyzer_dotnet
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

      # Also push to ACR for ACI deployment
      - name: Log in to ACR
        continue-on-error: true
        id: acr-login
        uses: docker/login-action@v3
        with:
          registry: ${{ env.ACR_LOGIN_SERVER }}
          username: ${{ env.ACR_NAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: Push to ACR
        if: steps.acr-login.outcome == 'success'
        run: |
          # Tag with both latest and run number for rollback capability
          docker tag ghcr.io/psford/claudeprojects/stockanalyzer:latest ${{ env.ACR_LOGIN_SERVER }}/stockanalyzer:latest
          docker tag ghcr.io/psford/claudeprojects/stockanalyzer:latest ${{ env.ACR_LOGIN_SERVER }}/stockanalyzer:prod-${{ github.run_number }}
          docker push ${{ env.ACR_LOGIN_SERVER }}/stockanalyzer:latest
          docker push ${{ env.ACR_LOGIN_SERVER }}/stockanalyzer:prod-${{ github.run_number }}

      - name: Record image info for rollback
        continue-on-error: true
        run: |
          echo "## Container Image" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** prod-${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "**Digest:** ${{ steps.build.outputs.digest }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          PREV_RUN=$(( ${{ github.run_number }} - 1 ))
          echo "To rollback, redeploy with tag: \`prod-${PREV_RUN}\`" >> $GITHUB_STEP_SUMMARY

  deploy:
    needs: build-container
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://psfordtaurus.com
    steps:
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Delete existing ACI (for clean redeploy)
        continue-on-error: true
        run: |
          az container delete \
            --resource-group rg-stockanalyzer-prod \
            --name stockanalyzer-er34ug \
            --yes

      - name: Deploy to Azure Container Instance
        run: |
          # Create ACI with new image
          az container create \
            --resource-group rg-stockanalyzer-prod \
            --name stockanalyzer-er34ug \
            --image ${{ env.ACR_LOGIN_SERVER }}/stockanalyzer:latest \
            --registry-login-server ${{ env.ACR_LOGIN_SERVER }} \
            --registry-username ${{ env.ACR_NAME }} \
            --registry-password ${{ secrets.ACR_PASSWORD }} \
            --dns-name-label stockanalyzer-er34ug \
            --ports 80 \
            --cpu 1 \
            --memory 1.5 \
            --environment-variables \
              ASPNETCORE_ENVIRONMENT=Production \
              ASPNETCORE_URLS=http://+:80 \
            --secure-environment-variables \
              ConnectionStrings__DefaultConnection="${{ secrets.AZURE_SQL_CONNECTION }}" \
              Finnhub__ApiKey="${{ secrets.FINNHUB_API_KEY }}" \
            --location westus2 \
            --os-type Linux \
            --restart-policy Always

      - name: Wait for container to start
        run: sleep 30

      - name: Health check
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" https://psfordtaurus.com/health/live)
          if [ $response -ne 200 ]; then
            echo "::error::Health check failed with status: $response"
            exit 1
          fi
          echo "Health check passed!"
          echo "## Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "Production is live at https://psfordtaurus.com" >> $GITHUB_STEP_SUMMARY

      - name: Azure Logout
        if: always()
        run: az logout
