<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Documentation - Stock Analyzer</title>
    <!-- Favicons -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <!-- Tailwind CSS - built locally from src/input.css -->
    <link rel="stylesheet" href="css/styles.css">
    <!-- marked.js for markdown rendering (UMD build for browser global) -->
    <script src="https://cdn.jsdelivr.net/npm/marked/lib/marked.umd.js"></script>
    <!-- Mermaid.js for architecture diagrams -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <!-- Fuse.js for fuzzy search -->
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@7.0.0/dist/fuse.min.js"></script>
</head>
<body class="h-screen bg-gray-50 dark:bg-gray-900 transition-colors overflow-hidden">
    <div class="h-full flex flex-col">
        <!-- Header - sticky -->
        <header class="flex-shrink-0 bg-white dark:bg-gray-800 shadow-sm border-b border-gray-200 dark:border-gray-700 transition-colors z-10">
            <div class="max-w-7xl mx-auto px-4 py-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <svg class="w-8 h-8 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Documentation</h1>
                    </div>
                    <div class="flex items-center space-x-4">
                        <a href="https://docs.psfordtaurus.com" class="text-sm text-primary hover:text-blue-600 dark:hover:text-blue-400 flex items-center gap-1" target="_blank">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                            </svg>
                            Latest Docs
                        </a>
                        <a href="/" class="text-sm text-primary hover:text-blue-600 dark:hover:text-blue-400 flex items-center gap-1">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                            </svg>
                            Back to App
                        </a>
                        <!-- Labels toggle (for Architecture tab only) -->
                        <button id="labels-toggle" class="hidden p-2 rounded-lg bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors" title="Show/hide AUTO/MANUAL labels">
                            <svg id="labels-icon" class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
                            </svg>
                        </button>
                        <!-- Dark mode toggle -->
                        <button id="dark-mode-toggle" class="p-2 rounded-lg bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors" title="Toggle dark mode">
                            <!-- Sun icon (shown in dark mode) -->
                            <svg id="sun-icon" class="w-5 h-5 text-yellow-500 hidden" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" clip-rule="evenodd"></path>
                            </svg>
                            <!-- Moon icon (shown in light mode) -->
                            <svg id="moon-icon" class="w-5 h-5 text-gray-600" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Tab Navigation - sticky -->
        <div class="flex-shrink-0 bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 z-10">
            <!-- Search box row - constrained width -->
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 sm:hidden">
                <div class="relative py-2">
                    <div class="flex items-center">
                        <svg class="absolute left-3 w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                        <input type="text" id="search-input-mobile" placeholder="Search docs..."
                               class="w-full pl-10 pr-4 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                    </div>
                    <!-- Search results dropdown (mobile) -->
                    <div id="search-results-mobile" class="hidden absolute left-0 right-0 mt-1 max-h-96 overflow-y-auto bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow-lg z-50">
                        <!-- Results populated by JS -->
                    </div>
                </div>
            </div>
            <!-- Tab row - full width scroll on mobile -->
            <div class="overflow-x-auto" style="-webkit-overflow-scrolling: touch;">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="flex items-center justify-between">
                        <nav class="flex space-x-4 sm:space-x-8 whitespace-nowrap min-w-max" aria-label="Tabs">
                            <button data-doc="explanation" class="tab-btn tab-active border-b-2 py-3 sm:py-4 px-1 text-sm font-medium transition-colors flex-shrink-0">
                                App Explanation
                            </button>
                            <button data-doc="claude" class="tab-btn border-b-2 border-transparent py-3 sm:py-4 px-1 text-sm font-medium text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 hover:border-gray-300 transition-colors flex-shrink-0">
                                Project Guidelines
                            </button>
                            <button data-doc="functional" class="tab-btn border-b-2 border-transparent py-3 sm:py-4 px-1 text-sm font-medium text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 hover:border-gray-300 transition-colors flex-shrink-0">
                                Functional Spec
                            </button>
                            <button data-doc="technical" class="tab-btn border-b-2 border-transparent py-3 sm:py-4 px-1 text-sm font-medium text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 hover:border-gray-300 transition-colors flex-shrink-0">
                                Technical Spec
                            </button>
                            <button data-doc="architecture" class="tab-btn border-b-2 border-transparent py-3 sm:py-4 px-1 text-sm font-medium text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 hover:border-gray-300 transition-colors flex-shrink-0">
                                Architecture
                            </button>
                            <button data-doc="security" class="tab-btn border-b-2 border-transparent py-3 sm:py-4 px-1 text-sm font-medium text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 hover:border-gray-300 transition-colors flex-shrink-0">
                                Security
                            </button>
                        </nav>
                        <!-- Search box - desktop only, inline with tabs -->
                        <div class="relative hidden sm:block flex-shrink-0 ml-4">
                            <div class="flex items-center">
                                <svg class="absolute left-3 w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                </svg>
                                <input type="text" id="search-input" placeholder="Search docs..."
                                       class="w-64 pl-10 pr-4 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                            </div>
                            <!-- Search results dropdown -->
                            <div id="search-results" class="hidden absolute right-0 mt-1 w-96 max-h-96 overflow-y-auto bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow-lg z-50">
                                <!-- Results populated by JS -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content Area - fills remaining height -->
        <div class="flex-1 flex min-h-0">
            <!-- Sidebar (TOC) - independent scroll, resizable -->
            <aside id="toc-container" class="bg-gray-50 dark:bg-gray-900 hidden lg:flex lg:flex-col" style="width: 256px; min-width: 150px; max-width: 500px;">
                <div class="flex-shrink-0 p-4 border-b border-gray-200 dark:border-gray-700">
                    <h3 class="text-sm font-semibold text-gray-900 dark:text-white">Table of Contents</h3>
                </div>
                <nav id="toc" class="flex-1 overflow-y-auto p-4 space-y-1">
                    <!-- Generated by JS -->
                </nav>
            </aside>

            <!-- Resize Handle -->
            <div id="resize-handle" class="w-1 bg-gray-200 dark:bg-gray-700 hover:bg-primary cursor-col-resize flex-shrink-0 hidden lg:block transition-colors"></div>

            <!-- Document Content - independent scroll -->
            <main class="flex-1 overflow-y-auto">
                <div class="max-w-4xl mx-auto px-6 py-8">
                    <div id="doc-content" class="text-gray-700 dark:text-gray-300">
                        <div class="flex items-center justify-center h-32">
                            <div class="text-center">
                                <div class="loader mx-auto mb-4"></div>
                                <p class="text-gray-500 dark:text-gray-400">Loading documentation...</p>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Footer inside scrollable content -->
                <footer class="bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 mt-8">
                    <div class="max-w-4xl mx-auto px-6 py-4">
                        <p class="text-sm text-gray-500 dark:text-gray-400 text-center">
                            Stock Analyzer Documentation &copy; 2026 | By Patrick Ford and Claude
                        </p>
                        <p class="text-sm text-gray-500 dark:text-gray-400 text-center mt-2">
                            <a href="/about.html" class="text-primary hover:text-blue-600 dark:hover:text-blue-400 hover:underline">About Us</a>
                            <span class="mx-2">|</span>
                            <a href="/" class="text-primary hover:text-blue-600 dark:hover:text-blue-400 hover:underline">Back to App</a>
                            <span class="mx-2">|</span>
                            <a href="https://github.com/psford/claudeProjects" target="_blank" class="text-primary hover:text-blue-600 dark:hover:text-blue-400 hover:underline">GitHub</a>
                        </p>
                    </div>
                </footer>
            </main>
        </div>
    </div>

    <style>
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3B82F6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>

    <script>
        const Docs = {
            currentDoc: 'explanation',
            docs: {
                explanation: { title: 'App Explanation', file: '/docs/APP_EXPLANATION.md' },
                claude: { title: 'Project Guidelines', file: '/docs/CLAUDE.md' },
                functional: { title: 'Functional Spec', file: '/docs/FUNCTIONAL_SPEC.md' },
                technical: { title: 'Technical Spec', file: '/docs/TECHNICAL_SPEC.md' },
                architecture: { title: 'Architecture', type: 'architecture' },
                security: { title: 'Security', file: '/docs/SECURITY_OVERVIEW.md' }
            },
            cache: {},
            fuse: null,
            searchIndex: [],

            async init() {
                this.initDarkMode();
                this.initLabelsToggle();
                this.initMermaid();
                this.initResize();
                this.initSearch();
                this.bindEvents();
                await this.loadDocument('explanation');
                await this.buildSearchIndex();
            },

            initSearch() {
                // Desktop search
                const searchInput = document.getElementById('search-input');
                const searchResults = document.getElementById('search-results');
                // Mobile search
                const searchInputMobile = document.getElementById('search-input-mobile');
                const searchResultsMobile = document.getElementById('search-results-mobile');
                let debounceTimer;

                const setupSearchInput = (input, results) => {
                    if (!input || !results) return;

                    input.addEventListener('input', (e) => {
                        clearTimeout(debounceTimer);
                        debounceTimer = setTimeout(() => {
                            this.handleSearch(e.target.value, results);
                        }, 200);
                    });

                    input.addEventListener('focus', () => {
                        if (input.value.length >= 2) {
                            this.handleSearch(input.value, results);
                        }
                    });

                    input.addEventListener('keydown', (e) => {
                        if (e.key === 'Escape') {
                            results.classList.add('hidden');
                            input.blur();
                        }
                    });
                };

                setupSearchInput(searchInput, searchResults);
                setupSearchInput(searchInputMobile, searchResultsMobile);

                // Close results when clicking outside
                document.addEventListener('click', (e) => {
                    if (searchInput && searchResults && !searchInput.contains(e.target) && !searchResults.contains(e.target)) {
                        searchResults.classList.add('hidden');
                    }
                    if (searchInputMobile && searchResultsMobile && !searchInputMobile.contains(e.target) && !searchResultsMobile.contains(e.target)) {
                        searchResultsMobile.classList.add('hidden');
                    }
                });
            },

            async buildSearchIndex() {
                this.searchIndex = [];

                // Index markdown documents
                for (const [docKey, doc] of Object.entries(this.docs)) {
                    if (doc.type === 'architecture') continue;

                    // Fetch if not cached
                    if (!this.cache[docKey]) {
                        try {
                            const response = await fetch(doc.file);
                            if (response.ok) {
                                this.cache[docKey] = await response.text();
                            }
                        } catch (e) {
                            continue;
                        }
                    }

                    const content = this.cache[docKey];
                    if (!content) continue;

                    // Split into sections by headings
                    const sections = this.parseMarkdownSections(content, docKey, doc.title);
                    this.searchIndex.push(...sections);
                }

                // Index architecture diagrams
                for (const diagram of this.diagrams) {
                    this.searchIndex.push({
                        docKey: 'architecture',
                        docTitle: 'Architecture',
                        title: diagram.title,
                        content: diagram.desc,
                        headingId: `heading-arch-${this.diagrams.indexOf(diagram) + 1}`
                    });
                }

                // Initialize Fuse.js
                this.fuse = new Fuse(this.searchIndex, {
                    keys: [
                        { name: 'title', weight: 2 },
                        { name: 'content', weight: 1 }
                    ],
                    threshold: 0.4,
                    ignoreLocation: true,
                    includeMatches: true,
                    minMatchCharLength: 2
                });
            },

            parseMarkdownSections(markdown, docKey, docTitle) {
                const sections = [];
                const lines = markdown.split('\n');
                let currentHeading = docTitle;
                let currentContent = [];
                let headingCount = 0;

                for (const line of lines) {
                    const headingMatch = line.match(/^(#{1,3})\s+(.+)$/);
                    if (headingMatch) {
                        // Save previous section
                        if (currentContent.length > 0) {
                            sections.push({
                                docKey,
                                docTitle,
                                title: currentHeading,
                                content: currentContent.join(' ').substring(0, 500),
                                headingId: `heading-${headingCount}`
                            });
                        }
                        currentHeading = headingMatch[2];
                        currentContent = [];
                        headingCount++;
                    } else if (line.trim()) {
                        // Strip markdown syntax for cleaner content
                        const cleanLine = line
                            .replace(/\*\*([^*]+)\*\*/g, '$1')
                            .replace(/\*([^*]+)\*/g, '$1')
                            .replace(/`([^`]+)`/g, '$1')
                            .replace(/\[([^\]]+)\]\([^)]+\)/g, '$1')
                            .replace(/^[-*]\s+/, '')
                            .replace(/^\d+\.\s+/, '');
                        currentContent.push(cleanLine);
                    }
                }

                // Don't forget last section
                if (currentContent.length > 0) {
                    sections.push({
                        docKey,
                        docTitle,
                        title: currentHeading,
                        content: currentContent.join(' ').substring(0, 500),
                        headingId: `heading-${headingCount}`
                    });
                }

                return sections;
            },

            handleSearch(query, resultsContainer = null) {
                const searchResults = resultsContainer || document.getElementById('search-results');

                if (query.length < 2) {
                    searchResults.classList.add('hidden');
                    return;
                }

                if (!this.fuse) {
                    searchResults.innerHTML = '<div class="search-no-results">Building search index...</div>';
                    searchResults.classList.remove('hidden');
                    return;
                }

                const results = this.fuse.search(query, { limit: 10 });
                this.displaySearchResults(results, query, searchResults);
            },

            displaySearchResults(results, query, resultsContainer = null) {
                const searchResults = resultsContainer || document.getElementById('search-results');

                if (results.length === 0) {
                    searchResults.innerHTML = '<div class="search-no-results">No results found</div>';
                    searchResults.classList.remove('hidden');
                    return;
                }

                const html = results.map(result => {
                    const item = result.item;
                    const snippet = this.highlightMatches(item.content, query);
                    const title = this.highlightMatches(item.title, query);

                    return `
                        <div class="search-result" data-doc="${item.docKey}" data-heading="${item.headingId}">
                            <div class="search-result-title">${title}</div>
                            <div class="search-result-doc">${item.docTitle}</div>
                            <div class="search-result-snippet">${snippet}</div>
                        </div>
                    `;
                }).join('');

                searchResults.innerHTML = html;
                searchResults.classList.remove('hidden');

                // Add click handlers
                searchResults.querySelectorAll('.search-result').forEach(el => {
                    el.addEventListener('click', () => {
                        const docKey = el.dataset.doc;
                        const headingId = el.dataset.heading;
                        this.navigateToResult(docKey, headingId);
                    });
                });
            },

            highlightMatches(text, query) {
                if (!text) return '';
                // Truncate long text
                let displayText = text.length > 150 ? text.substring(0, 150) + '...' : text;
                // Escape HTML
                displayText = displayText.replace(/</g, '&lt;').replace(/>/g, '&gt;');
                // Highlight query terms (case-insensitive)
                const words = query.split(/\s+/).filter(w => w.length >= 2);
                for (const word of words) {
                    const regex = new RegExp(`(${word.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
                    displayText = displayText.replace(regex, '<span class="search-highlight">$1</span>');
                }
                return displayText;
            },

            async navigateToResult(docKey, headingId) {
                const searchResults = document.getElementById('search-results');
                const searchResultsMobile = document.getElementById('search-results-mobile');
                const searchInput = document.getElementById('search-input');
                const searchInputMobile = document.getElementById('search-input-mobile');

                // Hide search results (both desktop and mobile)
                if (searchResults) searchResults.classList.add('hidden');
                if (searchResultsMobile) searchResultsMobile.classList.add('hidden');
                if (searchInput) searchInput.value = '';
                if (searchInputMobile) searchInputMobile.value = '';

                // Load the document if not current
                if (this.currentDoc !== docKey) {
                    await this.loadDocument(docKey);
                }

                // Wait a tick for DOM to update, then scroll to heading
                setTimeout(() => {
                    const heading = document.getElementById(headingId);
                    if (heading) {
                        heading.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        // Briefly highlight the heading
                        heading.style.backgroundColor = 'rgba(59, 130, 246, 0.2)';
                        setTimeout(() => {
                            heading.style.backgroundColor = '';
                        }, 2000);
                    }
                }, 100);
            },

            scrollSpyCleanup: null,

            initScrollSpy() {
                // Clean up previous scroll listener if exists
                if (this.scrollSpyCleanup) {
                    this.scrollSpyCleanup();
                }

                const mainScroller = document.querySelector('main');
                const content = document.getElementById('doc-content');
                const headings = Array.from(content.querySelectorAll('h1[id], h2[id], h3[id]'));

                if (headings.length === 0) return;

                // Track current active to avoid unnecessary DOM updates
                let currentActiveId = null;

                const updateActiveHeading = () => {
                    const scrollerRect = mainScroller.getBoundingClientRect();
                    const threshold = scrollerRect.top + 100; // 100px from top of scroll container

                    // Find the last heading that has scrolled past the threshold
                    let activeId = headings[0]?.id || null;

                    for (const heading of headings) {
                        const rect = heading.getBoundingClientRect();
                        if (rect.top <= threshold) {
                            activeId = heading.id;
                        } else {
                            break;
                        }
                    }

                    // Only update DOM if active changed
                    if (activeId !== currentActiveId) {
                        currentActiveId = activeId;
                        const toc = document.getElementById('toc');
                        toc.querySelectorAll('a').forEach(link => {
                            const isActive = link.getAttribute('href') === `#${activeId}`;
                            link.classList.toggle('toc-active', isActive);
                        });
                    }
                };

                // Initial update
                updateActiveHeading();

                // Throttled scroll handler
                let ticking = false;
                const onScroll = () => {
                    if (!ticking) {
                        requestAnimationFrame(() => {
                            updateActiveHeading();
                            ticking = false;
                        });
                        ticking = true;
                    }
                };

                mainScroller.addEventListener('scroll', onScroll, { passive: true });

                // Store cleanup function
                this.scrollSpyCleanup = () => {
                    mainScroller.removeEventListener('scroll', onScroll);
                };
            },

            initLabelsToggle() {
                const labelsToggle = document.getElementById('labels-toggle');
                const labelsIcon = document.getElementById('labels-icon');
                const content = document.getElementById('doc-content');

                // Check localStorage - default to hidden (false)
                const showLabels = localStorage.getItem('showDiagramLabels') === 'true';
                if (showLabels) {
                    content.classList.add('show-labels');
                    labelsIcon.classList.remove('text-gray-400');
                    labelsIcon.classList.add('text-primary');
                }

                labelsToggle.addEventListener('click', () => {
                    const isShowing = content.classList.toggle('show-labels');
                    localStorage.setItem('showDiagramLabels', isShowing);
                    labelsIcon.classList.toggle('text-gray-400', !isShowing);
                    labelsIcon.classList.toggle('text-primary', isShowing);
                });
            },

            initMermaid() {
                const isDark = document.documentElement.classList.contains('dark');
                mermaid.initialize({
                    startOnLoad: false,
                    theme: isDark ? 'dark' : 'default',
                    securityLevel: 'loose',
                    flowchart: { useMaxWidth: true, htmlLabels: true }
                });
            },

            initResize() {
                const handle = document.getElementById('resize-handle');
                const sidebar = document.getElementById('toc-container');
                let isResizing = false;

                handle.addEventListener('mousedown', (e) => {
                    isResizing = true;
                    document.body.style.cursor = 'col-resize';
                    document.body.style.userSelect = 'none';
                    handle.classList.add('bg-primary');
                });

                document.addEventListener('mousemove', (e) => {
                    if (!isResizing) return;
                    const newWidth = e.clientX;
                    if (newWidth >= 150 && newWidth <= 500) {
                        sidebar.style.width = newWidth + 'px';
                    }
                });

                document.addEventListener('mouseup', () => {
                    if (isResizing) {
                        isResizing = false;
                        document.body.style.cursor = '';
                        document.body.style.userSelect = '';
                        handle.classList.remove('bg-primary');
                        // Save width preference
                        localStorage.setItem('tocWidth', sidebar.style.width);
                    }
                });

                // Restore saved width
                const savedWidth = localStorage.getItem('tocWidth');
                if (savedWidth) {
                    sidebar.style.width = savedWidth;
                }
            },

            initDarkMode() {
                const darkModeToggle = document.getElementById('dark-mode-toggle');
                const sunIcon = document.getElementById('sun-icon');
                const moonIcon = document.getElementById('moon-icon');

                // Check localStorage or system preference
                const savedDarkMode = localStorage.getItem('darkMode');
                if (savedDarkMode === 'true' ||
                    (savedDarkMode === null && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                    document.documentElement.classList.add('dark');
                    sunIcon.classList.remove('hidden');
                    moonIcon.classList.add('hidden');
                }

                darkModeToggle.addEventListener('click', async () => {
                    document.documentElement.classList.toggle('dark');
                    const isDark = document.documentElement.classList.contains('dark');
                    localStorage.setItem('darkMode', isDark);
                    sunIcon.classList.toggle('hidden', !isDark);
                    moonIcon.classList.toggle('hidden', isDark);

                    // Re-render architecture diagrams if on that tab
                    if (this.currentDoc === 'architecture') {
                        await this.loadArchitecture();
                    }
                });
            },

            bindEvents() {
                // Tab click handlers
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        const docKey = btn.dataset.doc;
                        await this.loadDocument(docKey);
                    });
                });
            },

            async loadDocument(docKey) {
                const doc = this.docs[docKey];
                if (!doc) return;

                this.currentDoc = docKey;
                this.updateActiveTab(docKey);

                // Show/hide labels toggle (only visible on Architecture tab)
                const labelsToggle = document.getElementById('labels-toggle');
                labelsToggle.classList.toggle('hidden', doc.type !== 'architecture');

                // Handle architecture tab specially
                if (doc.type === 'architecture') {
                    await this.loadArchitecture();
                    return;
                }

                // Show loading state if not cached
                if (!this.cache[docKey]) {
                    document.getElementById('doc-content').innerHTML = `
                        <div class="flex items-center justify-center h-32">
                            <div class="text-center">
                                <div class="loader mx-auto mb-4"></div>
                                <p class="text-gray-500 dark:text-gray-400">Loading documentation...</p>
                            </div>
                        </div>
                    `;
                }

                try {
                    // Fetch and cache if needed
                    if (!this.cache[docKey]) {
                        const response = await fetch(doc.file);
                        if (!response.ok) throw new Error('Failed to load document');
                        this.cache[docKey] = await response.text();
                    }

                    // Render markdown
                    const html = marked.parse(this.cache[docKey]);
                    document.getElementById('doc-content').innerHTML = html;

                    // Generate TOC
                    this.generateTOC();

                    // Scroll to top
                    document.querySelector('main').scrollTop = 0;

                    // Initialize scroll spy for TOC highlighting
                    this.initScrollSpy();

                } catch (error) {
                    document.getElementById('doc-content').innerHTML = `
                        <div class="text-center py-8">
                            <p class="text-red-500">Error loading document: ${error.message}</p>
                        </div>
                    `;
                }
            },

            // Diagram definitions - loaded from external .mmd files
            diagrams: [
                { id: 'project-structure', title: 'Project Structure', desc: 'The solution contains three projects with their dependencies:', file: '/docs/diagrams/project-structure.mmd', auto: true },
                { id: 'service-architecture', title: 'Service Architecture', desc: 'The backend services and their responsibilities:', file: '/docs/diagrams/service-architecture.mmd', auto: false },
                { id: 'data-flow', title: 'Data Flow', desc: 'How data flows through the application when a user searches for a stock:', file: '/docs/diagrams/data-flow.mmd', auto: false },
                { id: 'domain-models', title: 'Domain Models', desc: 'Core data models used throughout the application:', file: '/docs/diagrams/domain-models.mmd', auto: false },
                { id: 'image-pipeline', title: 'Image Processing Pipeline', desc: 'The ML-based image processing for cat/dog images:', file: '/docs/diagrams/image-pipeline.mmd', auto: false },
                { id: 'frontend-architecture', title: 'Frontend Architecture', desc: 'Client-side JavaScript modules and their interactions:', file: '/docs/diagrams/frontend-architecture.mmd', auto: false },
                { id: 'api-endpoints', title: 'API Endpoints', desc: 'Complete list of REST API endpoints:', file: '/docs/diagrams/api-endpoints.mmd', auto: false }
            ],

            async loadArchitecture() {
                const content = document.getElementById('doc-content');
                const toc = document.getElementById('toc');

                // Show loading state
                content.innerHTML = `
                    <div class="flex items-center justify-center h-32">
                        <div class="text-center">
                            <div class="loader mx-auto mb-4"></div>
                            <p class="text-gray-500 dark:text-gray-400">Loading architecture diagrams...</p>
                        </div>
                    </div>
                `;

                // Re-initialize mermaid with current theme
                const isDark = document.documentElement.classList.contains('dark');
                mermaid.initialize({
                    startOnLoad: false,
                    theme: isDark ? 'dark' : 'default',
                    securityLevel: 'loose',
                    flowchart: { useMaxWidth: true, htmlLabels: true }
                });

                try {
                    // Fetch all diagram files in parallel
                    const diagramContents = await Promise.all(
                        this.diagrams.map(async (diagram) => {
                            const response = await fetch(diagram.file);
                            if (!response.ok) throw new Error(`Failed to load ${diagram.file}`);
                            const mmdContent = await response.text();
                            // Strip comment lines (lines starting with %%)
                            const cleanContent = mmdContent.split('\n')
                                .filter(line => !line.trim().startsWith('%%'))
                                .join('\n');
                            return { ...diagram, content: cleanContent };
                        })
                    );

                    // Build HTML content
                    let html = `
                        <h1 id="heading-arch-0">Architecture Overview</h1>
                        <p>Visual representations of the Stock Analyzer architecture, generated using Mermaid.js diagrams.</p>
                        <p class="diagram-legend text-sm text-gray-500 dark:text-gray-400 mt-2">
                            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200 mr-2">AUTO</span>
                            = Auto-generated during build
                            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200 ml-4 mr-2">MANUAL</span>
                            = Update in <code>/docs/diagrams/*.mmd</code>
                        </p>
                    `;

                    diagramContents.forEach((diagram, index) => {
                        const badge = diagram.auto
                            ? '<span class="diagram-label inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200 ml-2">AUTO</span>'
                            : '<span class="diagram-label inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200 ml-2">MANUAL</span>';

                        html += `
                            <h2 id="heading-arch-${index + 1}">${diagram.title}${badge}</h2>
                            <p>${diagram.desc}</p>
                            <div class="mermaid-container my-6">
                                <pre class="mermaid">${diagram.content}</pre>
                            </div>
                        `;
                    });

                    content.innerHTML = html;

                    // Generate TOC
                    let tocHtml = '<a href="#heading-arch-0" class="toc-h1">Architecture Overview</a>';
                    diagramContents.forEach((diagram, index) => {
                        tocHtml += `<a href="#heading-arch-${index + 1}" class="toc-h2">${diagram.title}</a>`;
                    });
                    toc.innerHTML = tocHtml;

                    // Render all mermaid diagrams
                    await mermaid.run({ nodes: document.querySelectorAll('.mermaid') });

                    // Scroll to top
                    document.querySelector('main').scrollTop = 0;

                    // Initialize scroll spy for TOC highlighting
                    this.initScrollSpy();

                } catch (error) {
                    content.innerHTML = `
                        <div class="text-center py-8">
                            <p class="text-red-500">Error loading diagrams: ${error.message}</p>
                        </div>
                    `;
                }
            },

            updateActiveTab(docKey) {
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    const isActive = btn.dataset.doc === docKey;
                    btn.classList.toggle('tab-active', isActive);
                    btn.classList.toggle('border-transparent', !isActive);
                    btn.classList.toggle('text-gray-500', !isActive);
                    btn.classList.toggle('dark:text-gray-400', !isActive);
                });
            },

            generateTOC() {
                const content = document.getElementById('doc-content');
                const toc = document.getElementById('toc');
                const headings = content.querySelectorAll('h1, h2, h3');

                let tocHtml = '';
                let idCounter = 0;

                headings.forEach(heading => {
                    // Generate unique ID
                    const id = `heading-${idCounter++}`;
                    heading.id = id;

                    // Determine heading level for styling
                    const level = heading.tagName.toLowerCase();
                    const levelClass = `toc-${level}`;

                    // Truncate long headings
                    let text = heading.textContent;
                    if (text.length > 40) {
                        text = text.substring(0, 37) + '...';
                    }

                    tocHtml += `<a href="#${id}" class="${levelClass}">${text}</a>`;
                });

                toc.innerHTML = tocHtml;
            }
        };

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', () => Docs.init());
    </script>
</body>
</html>
